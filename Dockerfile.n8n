FROM n8nio/n8n:latest

USER root

# Alpine —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏ + –∞–ø–¥–µ–π—Ç
RUN set -eux; \
  printf '%s\n' \
    "https://dl-cdn.alpinelinux.org/alpine/v3.22/main" \
    "https://dl-cdn.alpinelinux.org/alpine/v3.22/community" \
  > /etc/apk/repositories; \
  apk update; \
  apk upgrade --no-cache

# –°–∏—Å—Ç–µ–º–Ω—ã–µ –ø–∞–∫–µ—Ç—ã (ffmpeg –≤–∫–ª—é—á—ë–Ω) + docker-cli –¥–ª—è docker logs –≤–Ω—É—Ç—Ä–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
RUN apk add --no-cache \
  bash \
  curl \
  git \
  make \
  g++ \
  gcc \
  python3 \
  py3-pip \
  libffi-dev \
  yt-dlp \
  apache2-utils \
  ffmpeg \
  docker-cli \
  chromium \
  chromium-chromedriver \
  font-noto \
  font-noto-cjk \
  font-noto-emoji \
  imagemagick \
  ghostscript \
  graphicsmagick \
  poppler-utils \
  tesseract-ocr \
  tesseract-ocr-data-rus \
  tesseract-ocr-data-eng \
  jq

# (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ) –°–æ–∑–¥–∞—Ç—å –≥—Ä—É–ø–ø—É docker –∏ –¥–æ–±–∞–≤–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è node
ARG DOCKER_GID=999
RUN set -eux; \
  addgroup -S -g ${DOCKER_GID} docker || addgroup -S docker; \
  adduser node docker || true

# –ß—É—Ç—å —É—Å–∫–æ—Ä–∏–º npm
RUN npm config set fund false && npm config set audit false

# npm-–≥–ª–æ–±–∞–ª–∫–∏ (–æ—Å—Ç–∞–≤–ª—è–µ–º –≤—Å–µ –∫–∞–∫ —É —Ç–µ–±—è –±—ã–ª–æ)
RUN for pkg in \
    axios \
    node-fetch \
    form-data \
    moment \
    date-fns \
    lodash \
    fs-extra \
    path \
    csv-parser \
    xml2js \
    js-yaml \
    xlsx \
    jsonwebtoken \
    simple-oauth2 \
    uuid \
    openai \
    @tensorflow/tfjs-node \
    langchain \
    node-telegram-bot-api \
    discord.js \
    vk-io \
    whatsapp-web.js \
    fluent-ffmpeg \
    ffmpeg-static \
    google-tts-api \
    @vitalets/google-translate-token \
    node-wav \
    mongoose \
    ioredis \
    bcrypt \
    validator \
    joi \
    winston \
    dotenv \
    prom-client \
    node-downloader-helper \
    adm-zip \
    archiver \
  ; do \
    echo "üîß –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º $pkg..." && npm install -g "$pkg" || echo "‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å $pkg, –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º..."; \
  done

# –õ–æ–∫–∞–ª—å–Ω–æ ‚Äî –¥–ª—è –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ –≤ Code-–Ω–æ–¥–∞—Ö
RUN npm install oauth-1.0a

# Puppeteer –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –¥–ª—è headless browser (chromium —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è —á–µ—Ä–µ–∑ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ puppeteer)
ENV PUPPETEER_SKIP_CHROMIUM_DOWNLOAD=false
ENV PUPPETEER_EXECUTABLE_PATH=/usr/bin/chromium-browser
ENV CHROME_PATH=/usr/bin/chromium-browser

# n8n –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
ENV N8N_USER_FOLDER=/home/node/.n8n

USER node

WORKDIR /home/node

# –ö–†–ò–¢–ò–ß–ù–û: –ù–ï –ø–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª—è–µ–º CMD/ENTRYPOINT - –∏—Å–ø–æ–ª—å–∑—É–µ–º –∏–∑ –±–∞–∑–æ–≤–æ–≥–æ –æ–±—Ä–∞–∑–∞ n8nio/n8n
# –ë–∞–∑–æ–≤—ã–π –æ–±—Ä–∞–∑ –∏–º–µ–µ—Ç –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π entrypoint –¥–ª—è –∑–∞–ø—É—Å–∫–∞ n8n
