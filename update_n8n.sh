#!/bin/bash
# ============================================================
# –°–∫—Ä–∏–ø—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è n8n
# –í–µ—Ä—Å–∏—è 2.0 - –ë–ï–ó –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π –Ω–∞ –∑–∞–ø—É—Å–∫
# –ú–æ–∂–µ—Ç –±—ã—Ç—å –∑–∞–ø—É—â–µ–Ω –Ω–∞–ø—Ä—è–º—É—é –∏–ª–∏ —á–µ—Ä–µ–∑ Telegram –±–æ—Ç–∞
# ============================================================

set -e

# –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ —Å–∫—Ä–∏–ø—Ç–∞
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
cd "$SCRIPT_DIR"

# –¶–≤–µ—Ç–∞ –¥–ª—è –≤—ã–≤–æ–¥–∞
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

log_info() { echo -e "${BLUE}[INFO]${NC} $(date '+%Y-%m-%d %H:%M:%S') $1"; }
log_success() { echo -e "${GREEN}[OK]${NC} $(date '+%Y-%m-%d %H:%M:%S') $1"; }
log_warning() { echo -e "${YELLOW}[WARN]${NC} $(date '+%Y-%m-%d %H:%M:%S') $1"; }
log_error() { echo -e "${RED}[ERROR]${NC} $(date '+%Y-%m-%d %H:%M:%S') $1"; }

# –ó–∞–≥—Ä—É–∑–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è
if [ -f "$SCRIPT_DIR/.env" ]; then
    set -a
    source "$SCRIPT_DIR/.env"
    set +a
fi

# –î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è –ª–æ–≥–æ–≤
LOG_DIR="$SCRIPT_DIR/logs"
mkdir -p "$LOG_DIR"
LOG_FILE="$LOG_DIR/update_$(date +%Y%m%d_%H%M%S).log"

# –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ —Ñ–∞–π–ª
exec > >(tee -a "$LOG_FILE") 2>&1

# –§—É–Ω–∫—Ü–∏—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –≤ Telegram
send_telegram() {
    local message="$1"
    if [ -n "$TG_BOT_TOKEN" ] && [ -n "$TG_USER_ID" ]; then
        curl -s -X POST "https://api.telegram.org/bot${TG_BOT_TOKEN}/sendMessage" \
            -d "chat_id=${TG_USER_ID}" \
            -d "text=${message}" \
            -d "parse_mode=Markdown" > /dev/null 2>&1 || true
    fi
}

# ============================================================
# –ù–∞—á–∞–ª–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
# ============================================================

log_info "=========================================="
log_info "    –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ n8n"
log_info "=========================================="

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —á—Ç–æ Docker –∑–∞–ø—É—â–µ–Ω
log_info "–ü—Ä–æ–≤–µ—Ä–∫–∞ Docker..."
if ! systemctl is-active --quiet docker; then
    log_error "Docker –Ω–µ –∑–∞–ø—É—â–µ–Ω. –ó–∞–ø—É—Å—Ç–∏—Ç–µ –µ–≥–æ: systemctl start docker"
    send_telegram "‚ùå –û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è: Docker –Ω–µ –∑–∞–ø—É—â–µ–Ω"
    exit 1
fi

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —á—Ç–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä n8n —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
if ! docker ps -a --format '{{.Names}}' | grep -q "^n8n$"; then
    log_error "–ö–æ–Ω—Ç–µ–π–Ω–µ—Ä n8n –Ω–µ –Ω–∞–π–¥–µ–Ω"
    send_telegram "‚ùå –û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è: –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä n8n –Ω–µ –Ω–∞–π–¥–µ–Ω"
    exit 1
fi

# –ü–æ–ª—É—á–µ–Ω–∏–µ —Ç–µ–∫—É—â–µ–π –≤–µ—Ä—Å–∏–∏
log_info "–ü–æ–ª—É—á–µ–Ω–∏–µ —Ç–µ–∫—É—â–µ–π –≤–µ—Ä—Å–∏–∏ n8n..."
if ! CURRENT_VERSION=$(docker exec n8n n8n --version 2>&1); then
    log_warning "–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å —Ç–µ–∫—É—â—É—é –≤–µ—Ä—Å–∏—é n8n (–∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –º–æ–∂–µ—Ç –±—ã—Ç—å –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω)"
    CURRENT_VERSION="unknown"
else
    CURRENT_VERSION=$(echo "$CURRENT_VERSION" | tr -d '\n\r')
fi
log_info "–¢–µ–∫—É—â–∞—è –≤–µ—Ä—Å–∏—è: $CURRENT_VERSION"

# –ü–æ–ª—É—á–µ–Ω–∏–µ –ø–æ—Å–ª–µ–¥–Ω–µ–π –≤–µ—Ä—Å–∏–∏
log_info "–ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ—Å–ª–µ–¥–Ω–µ–π –≤–µ—Ä—Å–∏–∏ –Ω–∞ GitHub..."
if ! command -v curl &>/dev/null; then
    log_error "curl –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –µ–≥–æ: apt-get install curl"
    exit 1
fi

LATEST_VERSION=$(curl -s --max-time 10 https://api.github.com/repos/n8n-io/n8n/releases/latest 2>&1 | \
    grep '"tag_name"' | \
    sed -E 's/.*"n8n@([^"]+)".*/\1/' 2>/dev/null || echo "unknown")

if [ "$LATEST_VERSION" = "unknown" ]; then
    log_warning "–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –≤–µ—Ä—Å–∏—é —Å GitHub, –ø—Ä–æ–±—É–µ–º npm registry..."
    # –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π —Å–ø–æ—Å–æ–± –ø–æ–ª—É—á–µ–Ω–∏—è –≤–µ—Ä—Å–∏–∏
    LATEST_VERSION=$(curl -s --max-time 10 https://registry.npmjs.org/n8n/latest 2>&1 | \
        grep -o '"version":"[^"]*"' | \
        cut -d'"' -f4 2>/dev/null || echo "unknown")
fi

if [ "$LATEST_VERSION" = "unknown" ]; then
    log_error "–ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –ø–æ—Å–ª–µ–¥–Ω—é—é –≤–µ—Ä—Å–∏—é n8n. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç—É."
    send_telegram "‚ùå –û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è: –Ω–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –ø–æ—Å–ª–µ–¥–Ω—é—é –≤–µ—Ä—Å–∏—é"
    exit 1
fi

log_info "–ü–æ—Å–ª–µ–¥–Ω—è—è –≤–µ—Ä—Å–∏—è: $LATEST_VERSION"

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
if [ "$CURRENT_VERSION" = "$LATEST_VERSION" ] && [ "$CURRENT_VERSION" != "unknown" ]; then
    log_success "–£–∂–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞ –ø–æ—Å–ª–µ–¥–Ω—è—è –≤–µ—Ä—Å–∏—è n8n ($CURRENT_VERSION)"
    send_telegram "‚úÖ n8n —É–∂–µ –æ–±–Ω–æ–≤–ª—ë–Ω –¥–æ –ø–æ—Å–ª–µ–¥–Ω–µ–π –≤–µ—Ä—Å–∏–∏ $CURRENT_VERSION"
    exit 0
fi

send_telegram "üîÑ *–ù–∞—á–∏–Ω–∞—é –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ n8n*

üì¶ –¢–µ–∫—É—â–∞—è –≤–µ—Ä—Å–∏—è: $CURRENT_VERSION
üÜï –¶–µ–ª–µ–≤–∞—è –≤–µ—Ä—Å–∏—è: $LATEST_VERSION"

# ============================================================
# –°–æ–∑–¥–∞–Ω–∏–µ —Ä–µ–∑–µ—Ä–≤–Ω–æ–π –∫–æ–ø–∏–∏
# ============================================================

log_info "–°–æ–∑–¥–∞–Ω–∏–µ —Ä–µ–∑–µ—Ä–≤–Ω–æ–π –∫–æ–ø–∏–∏..."
if [ -f "$SCRIPT_DIR/backup_n8n.sh" ]; then
    if "$SCRIPT_DIR/backup_n8n.sh"; then
        log_success "–†–µ–∑–µ—Ä–≤–Ω–∞—è –∫–æ–ø–∏—è —Å–æ–∑–¥–∞–Ω–∞"
    else
        log_warning "–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å —Ä–µ–∑–µ—Ä–≤–Ω—É—é –∫–æ–ø–∏—é"
    fi
else
    log_warning "–°–∫—Ä–∏–ø—Ç –±—ç–∫–∞–ø–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω"
fi

# ============================================================
# –û—Å—Ç–∞–Ω–æ–≤–∫–∞ n8n
# ============================================================

log_info "–û—Å—Ç–∞–Ω–æ–≤–∫–∞ n8n..."
STOP_OUTPUT=$(docker compose stop n8n 2>&1 || docker-compose stop n8n 2>&1)
if [ $? -ne 0 ]; then
    log_error "–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å n8n: $STOP_OUTPUT"
    send_telegram "‚ùå –û—à–∏–±–∫–∞ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ n8n –ø–µ—Ä–µ–¥ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ–º"
    exit 1
fi
log_success "n8n –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω"

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —á—Ç–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω
sleep 2
if docker ps --format '{{.Names}}' | grep -q "^n8n$"; then
    log_warning "–ö–æ–Ω—Ç–µ–π–Ω–µ—Ä n8n –≤—Å—ë –µ—â—ë —Ä–∞–±–æ—Ç–∞–µ—Ç, –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º..."
    docker stop n8n 2>&1 || {
        log_error "–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä n8n"
        exit 1
    }
fi

# ============================================================
# –ü–µ—Ä–µ—Å–±–æ—Ä–∫–∞ –æ–±—Ä–∞–∑–∞
# ============================================================

log_info "–ü–µ—Ä–µ—Å–±–æ—Ä–∫–∞ Docker –æ–±—Ä–∞–∑–∞ n8n..."
log_info "–≠—Ç–æ –º–æ–∂–µ—Ç –∑–∞–Ω—è—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ –º–∏–Ω—É—Ç..."

BUILD_OUTPUT=$(docker compose build --no-cache n8n 2>&1)
BUILD_EXIT=$?

if [ $BUILD_EXIT -ne 0 ]; then
    # –ü—Ä–æ–±—É–µ–º —Å docker-compose
    BUILD_OUTPUT=$(docker-compose build --no-cache n8n 2>&1)
    BUILD_EXIT=$?
fi

if [ $BUILD_EXIT -ne 0 ]; then
    log_error "–û—à–∏–±–∫–∞ –ø–µ—Ä–µ—Å–±–æ—Ä–∫–∏ –æ–±—Ä–∞–∑–∞:"
    echo "$BUILD_OUTPUT" | tail -20
    send_telegram "‚ùå –û—à–∏–±–∫–∞ –ø–µ—Ä–µ—Å–±–æ—Ä–∫–∏ –æ–±—Ä–∞–∑–∞ n8n. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏."
    exit 1
fi
log_success "–û–±—Ä–∞–∑ –ø–µ—Ä–µ—Å–æ–±—Ä–∞–Ω"

# ============================================================
# –ó–∞–ø—É—Å–∫ n8n
# ============================================================

log_info "–ó–∞–ø—É—Å–∫ n8n..."
START_OUTPUT=$(docker compose up -d n8n 2>&1)
START_EXIT=$?

if [ $START_EXIT -ne 0 ]; then
    # –ü—Ä–æ–±—É–µ–º —Å docker-compose
    START_OUTPUT=$(docker-compose up -d n8n 2>&1)
    START_EXIT=$?
fi

if [ $START_EXIT -ne 0 ]; then
    log_error "–û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞ n8n:"
    echo "$START_OUTPUT"
    send_telegram "‚ùå –û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞ n8n –ø–æ—Å–ª–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è"
    exit 1
fi
log_success "n8n –∑–∞–ø—É—â–µ–Ω"

# ============================================================
# –û–∂–∏–¥–∞–Ω–∏–µ –∑–∞–ø—É—Å–∫–∞
# ============================================================

log_info "–û–∂–∏–¥–∞–Ω–∏–µ –∑–∞–ø—É—Å–∫–∞ n8n (–¥–æ 60 —Å–µ–∫—É–Ω–¥)..."
n8n_healthy=false
for i in {1..30}; do
    sleep 2
    if docker exec n8n wget --spider -q http://localhost:5678/healthz 2>/dev/null; then
        log_success "n8n –æ—Ç–≤–µ—á–∞–µ—Ç –Ω–∞ healthcheck"
        n8n_healthy=true
        break
    fi

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –≤—Å—ë –µ—â—ë —Ä–∞–±–æ—Ç–∞–µ—Ç
    if ! docker ps --format '{{.Names}}' | grep -q "^n8n$"; then
        log_error "–ö–æ–Ω—Ç–µ–π–Ω–µ—Ä n8n –æ—Å—Ç–∞–Ω–æ–≤–∏–ª—Å—è –≤–æ –≤—Ä–µ–º—è –∑–∞–ø—É—Å–∫–∞"
        log_error "–õ–æ–≥–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞:"
        docker logs n8n --tail 50
        send_telegram "‚ùå –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä n8n –æ—Å—Ç–∞–Ω–æ–≤–∏–ª—Å—è –≤–æ –≤—Ä–µ–º—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è"
        exit 1
    fi

    echo -n "."
done
echo ""

if [ "$n8n_healthy" == "false" ]; then
    log_warning "n8n –Ω–µ –æ—Ç–≤–µ—Ç–∏–ª –Ω–∞ healthcheck –∑–∞ 60 —Å–µ–∫—É–Ω–¥"
    log_warning "–ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞..."

    CONTAINER_STATUS=$(docker inspect n8n --format='{{.State.Status}}' 2>/dev/null || echo "unknown")
    log_info "–°—Ç–∞—Ç—É—Å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞: $CONTAINER_STATUS"

    if [ "$CONTAINER_STATUS" == "running" ]; then
        log_warning "–ö–æ–Ω—Ç–µ–π–Ω–µ—Ä —Ä–∞–±–æ—Ç–∞–µ—Ç, –Ω–æ healthcheck –Ω–µ –æ—Ç–≤–µ—á–∞–µ—Ç"
        log_warning "–í–æ–∑–º–æ–∂–Ω–æ, n8n –≤—Å—ë –µ—â—ë –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è. –ü–æ–¥–æ–∂–¥–∏—Ç–µ –µ—â—ë –º–∏–Ω—É—Ç—É."
    else
        log_error "–ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç. –ü–æ—Å–ª–µ–¥–Ω–∏–µ –ª–æ–≥–∏:"
        docker logs n8n --tail 50
        send_telegram "‚ùå –û—à–∏–±–∫–∞: n8n –Ω–µ –∑–∞–ø—É—Å—Ç–∏–ª—Å—è –ø–æ—Å–ª–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è"
        exit 1
    fi
fi

# ============================================================
# –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–æ–≤–æ–π –≤–µ—Ä—Å–∏–∏
# ============================================================

sleep 5
NEW_VERSION=$(docker exec n8n n8n --version 2>/dev/null || echo "unknown")
log_info "–í–µ—Ä—Å–∏—è –ø–æ—Å–ª–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è: $NEW_VERSION"

# ============================================================
# –û—á–∏—Å—Ç–∫–∞ Docker
# ============================================================

log_info "–û—á–∏—Å—Ç–∫–∞ Docker..."
docker image prune -f > /dev/null 2>&1 || true
docker builder prune -f > /dev/null 2>&1 || true

# ============================================================
# –û—á–∏—Å—Ç–∫–∞ —Å–∏—Å—Ç–µ–º—ã
# ============================================================

log_info "–û—á–∏—Å—Ç–∫–∞ —Å–∏—Å—Ç–µ–º—ã..."
# –£–¥–∞–ª–µ–Ω–∏–µ –Ω–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã—Ö –ø–∞–∫–µ—Ç–æ–≤
apt-get autoremove -y -qq > /dev/null 2>&1 || true

# –û—á–∏—Å—Ç–∫–∞ –∂—É—Ä–Ω–∞–ª–æ–≤
journalctl --vacuum-time=7d > /dev/null 2>&1 || true

# –£–¥–∞–ª–µ–Ω–∏–µ —Å—Ç–∞—Ä—ã—Ö –ª–æ–≥–æ–≤ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è (—Å—Ç–∞—Ä—à–µ 30 –¥–Ω–µ–π)
find "$LOG_DIR" -name "update_*.log" -mtime +30 -delete 2>/dev/null || true

# ============================================================
# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞
# ============================================================

STATUS=$(docker ps --filter name=n8n --format "{{.Status}}" 2>/dev/null || echo "unknown")
log_info "–°—Ç–∞—Ç—É—Å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞: $STATUS"

if echo "$STATUS" | grep -q "Up"; then
    log_success "=========================================="
    log_success "    –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à–µ–Ω–æ!"
    log_success "=========================================="

    send_telegram "‚úÖ *–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ n8n –∑–∞–≤–µ—Ä—à–µ–Ω–æ!*

üì¶ –°—Ç–∞—Ä–∞—è –≤–µ—Ä—Å–∏—è: $CURRENT_VERSION
üÜï –ù–æ–≤–∞—è –≤–µ—Ä—Å–∏—è: $NEW_VERSION
üìä –°—Ç–∞—Ç—É—Å: $STATUS

üîó –õ–æ–≥: $LOG_FILE"

    exit 0
else
    log_error "=========================================="
    log_error "    –û—à–∏–±–∫–∞: –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –Ω–µ –∑–∞–ø—É—Å—Ç–∏–ª—Å—è"
    log_error "=========================================="

    send_telegram "‚ùå *–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è n8n*

–ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –Ω–µ –∑–∞–ø—É—Å—Ç–∏–ª—Å—è –ø–æ—Å–ª–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è.
–°—Ç–∞—Ç—É—Å: $STATUS

–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏:
\`docker logs n8n\`

üîó –õ–æ–≥ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è: $LOG_FILE"

    exit 1
fi
